
#1 Which channel is most frequently used for transactions?

SELECT STORE_TYPE, COUNT(TRANSACTION_ID) Count_
FROM `statfinity_sql_case.Transaction` 
GROUP BY STORE_TYPE
ORDER BY COUNT(TRANSACTION_ID) DESC

#2 What is the count of Male and Female customers in the database?

SELECT GENDER, COUNT(CUSTOMER_ID) AS COUNTG
FROM `statfinity_sql_case.Customers`
WHERE GENDER IN ('M' , 'F')
GROUP BY GENDER

#3 From which city do we have the maximum number of customers and how many?

SELECT top 1 CITY_CODE, COUNT(CUSTOMER_ID) CUST_CNT
FROM `statfinity_sql_case.Customers`
GROUP BY CITY_CODE
ORDER BY CUST_CNT DESC


#4 How many sub-categories are there under the Books category? 

SELECT COUNT(prod_subcat) AS SUBCAT_CNT
FROM `statfinity_sql_case.prod_cat`
WHERE prod_cat = 'BOOKS'
GROUP BY prod_cat


#5 What is the maximum quantity of products ever ordered?

SELECT QTY 
FROM `statfinity_sql_case.Transaction`
ORDER BY QTY desc

#6 What is the net total revenue generated in categories Electronics and Books

SELECT SUM(TOTAL_AMT) AMOUNT
FROM `statfinity_sql_case.Transaction`
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code = prod_cat_code 
AND prod_sub_cat_code = PROD_SUBCAT_CODE
WHERE PROD_CAT IN ('BOOKS' , 'ELECTRONICS')

#7 How many customers have >10 transactions with us, excluding returns?

SELECT COUNT(CUSTOMER_ID) AS CUSTOMER_COUNT
FROM `statfinity_sql_case.Customers` WHERE CUSTOMER_ID IN 
(
SELECT CUST_ID
FROM `statfinity_sql_case.Transaction`
LEFT JOIN `statfinity_sql_case.Customers` ON CUSTOMER_ID = CUST_ID
WHERE TOTAL_AMT NOT LIKE '-%'
GROUP BY
CUST_ID
HAVING 
COUNT(TRANSACTION_ID) > 10
)


#8 What is the combined revenue earned from the “Electronics” & “Clothing” categories, from “Flagship stores”?

SELECT SUM(TOTAL_AMT) AS AMOUNT FROM `statfinity_sql_case.Transaction`
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code = prod_cat_code 
	  AND prod_sub_cat_code = prod_subcat_code
WHERE PROD_CAT IN ('CLOTHING','ELECTRONICS') AND STORE_TYPE = 'FLAGSHIP STORE'

#9 What is the total revenue generated from “Male” customers in “Electronics” category? Output should display total revenue by  prod sub-cat.

SELECT prod_subcat_code, SUM(TOTAL_AMT) REVENUE
FROM `statfinity_sql_case.Transaction`
LEFT JOIN `statfinity_sql_case.Customers` ON CUST_ID=CUSTOMER_ID
LEFT JOIN `statfinity_sql_case.prod_cat` ON prod_sub_cat_code = prod_subcat_code AND prod_cat_code = prod_cat_code
WHERE PROD_CAT_CODE= '3' AND GENDER = 'M'
GROUP BY PROD_SUBCAT_CODE, PROD_SUBCAT

#10 What is percentage of sales and returns by product sub category; display only top 5 sub categories in terms of sales?

SELECT TOP 5 
PROD_SUBCAT, (SUM(TOTAL_AMT)/(SELECT SUM(TOTAL_AMT) FROM `statfinity_sql_case.Transaction`))*100 AS PERCANTAGE_OF_SALES, 
(COUNT(CASE WHEN QTY< 0 THEN QTY ELSE NULL END)/SUM(QTY))*100 AS PERCENTAGE_OF_RETURN
FROM `statfinity_sql_case.Transaction`
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code = prod_cat_code AND prod_subcat_code = prod_sub_cat_code
GROUP BY PROD_SUBCAT
ORDER BY SUM(TOTAL_AMT) DESC


#11 For all customers aged between 25 to 35 years find what is the net total revenue generated by these consumers in last 30 days of transactions from max transaction date available in the data?

SELECT CUST_ID,SUM(TOTAL_AMT) AS REVENUE FROM `statfinity_sql_case.Transaction`
WHERE CUST_ID IN 
	(SELECT CUSTOMER_ID
	 FROM `statfinity_sql_case.Customers`
     WHERE DATEDIFF(YEAR,CONVERT(DATE,DOB,103),GETDATE()) BETWEEN 25 AND 35)
     AND CONVERT(DATE,TRAN_DTE,103) BETWEEN DATEADD(DAY,-30,(SELECT MAX(CONVERT(DATE,TRAN_DTE,103)) FROM `statfinity_sql_case.Transaction`)) 
	 AND (SELECT MAX(CONVERT(DATE,TRAN_DTE,103)) FROM `statfinity_sql_case.Transaction`)
GROUP BY CUST_ID


#12 Which product category has seen the max value of returns in the last 3 months of transactions?

SELECT TOP 1 PROD_CAT, SUM(TOTAL_AMT) FROM `statfinity_sql_case.Transaction` T1
INNER JOIN `statfinity_sql_case.prod_cat` T2 ON T1.PROD_CAT_CODE = T2.prod_cat_code AND 
										T1.PROD_SUBCAT_CODE = T2.prod_sub_cat_code
WHERE TOTAL_AMT < 0 AND 
CONVERT(date, TRAN_DTE, 103) BETWEEN DATEADD(MONTH,-3,(SELECT MAX(CONVERT(DATE,TRAN_DTE,103)) FROM `statfinity_sql_case.Transaction`)) 
	 AND (SELECT MAX(CONVERT(DATE,TRAN_DTE,103)) FROM `statfinity_sql_case.Transaction`)
GROUP BY PROD_CAT
ORDER BY 2 DESC


#13 Which store-type sells the maximum products; by value of sales amount and by quantity sold? 

SELECT  STORE_TYPE, SUM(TOTAL_AMT) TOT_SALES, SUM(QTY) TOT_QUAN
FROM `statfinity_sql_case.Transaction`
GROUP BY STORE_TYPE
HAVING SUM(TOTAL_AMT) >=ALL (SELECT SUM(TOTAL_AMT) FROM `statfinity_sql_case.Transaction` GROUP BY STORE_TYPE)
AND SUM(QTY) >=ALL (SELECT SUM(QTY) FROM `statfinity_sql_case.Transaction` GROUP BY STORE_TYPE)

#14 What are the categories for which average revenue is above the overall average.

SELECT PROD_CAT, AVG(TOTAL_AMT) AS AVERAGE
FROM `statfinity_sql_case.Transaction`
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code = PROD_CAT_CODE AND prod_sub_cat_code
=PROD_SUBCAT_CODE
GROUP BY PROD_CAT
HAVING AVG(TOTAL_AMT)> (SELECT AVG(TOTAL_AMT) FROM `statfinity_sql_case.Transaction`)


#15 Find the average and total revenue by each subcategory for the categories which are among top 5 categories in terms of quantity sold.

SELECT PROD_CAT, PROD_SUBCAT, AVG(TOTAL_AMT) AS AVERAGE_REV, SUM(TOTAL_AMT) AS REVENUE
FROM `statfinity_sql_case.Transaction`
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code=PROD_CAT_CODE AND prod_sub_cat_code=PROD_SUBCAT_CODE
WHERE PROD_CAT IN
(
SELECT TOP 5 
PROD_CAT
FROM `statfinity_sql_case.Transaction` 
INNER JOIN `statfinity_sql_case.prod_cat` ON prod_cat_code= PROD_CAT_CODE AND prod_sub_cat_code = PROD_SUBCAT_CODE
GROUP BY PROD_CAT
ORDER BY SUM(QTY) DESC
)
GROUP BY PROD_CAT, PROD_SUBCAT 

